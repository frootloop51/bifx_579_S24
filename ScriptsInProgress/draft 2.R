######################################################

# Tool 1A: Identify that a genomic region in an intron or between genes is expressed based on RNAseq data
# Author: Ian Lacy
# Date: March 27, 2024
#####################################################

# The purpose of this script is to analyze all samples in each study of interest and measure coverage across a region of the genome between specific genomic coordinates.
#There are three steps to complete the analysis.  
#The script begins with generating a BED annotation file that specifies the putative exons that the user wishes to check for differential expression. The second step
#includes calculating the coverage of the desired regions and combining  all of the coverage matrices into one overall coverage matrix.  
#The third step includes Exploratory/Visual Analysis.

#Note: this script is very much incomplete and I need significant feedback on where to go from here.

#####################################################


# Step One: Creating a BED file for processing BigWig Files

# load the necessary packages needed to complete the differential expression analysis
library(GenomicRanges) #a megadepth tool will eventually generate a GRanges object
library(recount3) #loads the study information
library(megadepth) #provides new tools for analysis, including the get_coverage function which seems to streamline a lot of work.
library(dplyr)


#Creating a BED file from the CSV generated by Professor Darby's GRange generating script
csv_data <- read.csv("C:/Users/ianla.000/Documents/bifxproject/NovelCommonMajorExons.csv", header=TRUE) #This file was generated from Dr. Darby's script which gives the genomic coordinates.

csv_data <- setNames(csv_data, c("chrom", "chromStart", "chromEnd", "strand"))
csv_data

# Write to BED file
write.table(csv_data, "annotation_file.bed", sep="\t", col.names = FALSE, row.names=FALSE, quote=FALSE)

#####################################################

# Step Two: Calculating coverage of the desired regions


##Note: Not sure I even need to load an SRE if I'm using megadepth and the bigwig files, but I'll leave it in for now.
# Load in the recount3 project to be used in differential expression analysis
Avail_projects <- available_projects()

## Find the project you are interested in,
SelectedStudy <- subset(
  Avail_projects,
  project == "SRP043684" & project_type == "data_sources"
)

#create rse for SRP043684
#this file was used because it was listed in one of the scripts provided by Dr. Darby.
rse_gene_SRP043684 <- create_rse(SelectedStudy)

summary(rse_gene_SRP043684)


##download the BigWig files for SRP043684 for local processing
#download_study('SRP043684', type = 'samples') #this is commented out to prevent accidental download


##calculate coverage using get_coverage from megadepth
##This is only an example piece of code to prove that it works. I am working on creating a loop that will look
## at many BigWig Files and create GRanges objects for each of them. 


SRR1501382_bw <- "C:/Users/ianla.000/Documents/bifxproject/SRP043684/bw/SRR1501367.bw" #tells get_coverage where to find the BigWig file
SRR1501381_bw <- "C:/Users/ianla.000/Documents/bifxproject/SRP043684/bw/SRR1501368.bw"


annotation_file <- "C:/Users/ianla.000/Documents/bifxproject/annotation_file.bed"

#This function takes the BigWig file then finds the mean coverage based on the coordinates in the BED/annotation file.
SRR1501382_cov <- get_coverage(
  SRR1501382_bw,
  op = "mean",
  annotation = annotation_file
)

SRR1501381_cov <- get_coverage(
  SRR1501381_bw,
  op = "mean",
  annotation = annotation_file
)

#displays the genomic ranges object with the coverage score (metadata)
SRR1501382_cov
SRR1501381_cov


## There were a variety of intermediate steps I did not fully understand but would love to discuss later on. 
## But, for the purposes of this script, I skipped straight to the data visualization/analysis portion.

#Step 3: Visualization and Analysis
#In this step, I plan to do some sort of visualization with the information from
# the GRanges object created from get_coverage using Gviz. I think the visualization should be sufficient for this portion of the pipeline.

#I'm not super confident on where to go from here. I can continue in this manner and focus only on 
#coverage data and visualization or I can try and find ways to conduct analysis. Again, I'm very green in this area.
